<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JomGather - Chat with {{ other_user.username }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
</head>
<body>
<nav class="navbar" aria-label="Main navigation">
  <div class="navbar__container">
    <a href="{{ url_for('index') }}" id="navbar__logo" aria-label="JomGather Home">JomGather</a>
    <div class="navbar__toggle" id="mobile-menu">
      <span class="bar" aria-hidden="true"></span>
      <span class="bar" aria-hidden="true"></span>
      <span class="bar" aria-hidden="true"></span>
    </div>
    <ul class="navbar__menu" role="menubar">
      <li class="navbar__item" role="none">
        <a href="{{ url_for('index') }}" class="navbar__links {% if request.endpoint == 'index' %}active{% endif %}" role="menuitem">Home</a>
      </li>
      <li class="navbar__item" role="none">
        <a href="{{ url_for('customise') }}" class="navbar__links {% if request.endpoint == 'customise' %}active{% endif %}" role="menuitem">Customize Profile</a>
      </li>
      <li class="navbar__item" role="none">
        <a href="{{ url_for('jomgather') }}" class="navbar__links {% if request.endpoint == 'jomgather' %}active{% endif %}" role="menuitem">Jom Gather</a>
      </li>
      {% if current_user.is_authenticated %}
      <li class="navbar__item" role="none">
        <a href="{{ url_for('view_connections') }}" class="navbar__links {% if request.endpoint == 'view_connections' %}active{% endif %}" role="menuitem">My Connections</a>
      </li>
      <li class="navbar__btn" role="none">
        <a href="{{ url_for('logout') }}" class="button" role="menuitem">Logout</a>
      </li>
      {% else %}
      <li class="navbar__btn" role="none">
        <a href="{{ url_for('register') }}" class="button" role="menuitem">Sign Up/Log In</a>
      </li>
      {% endif %}
    </ul>
  </div>
</nav>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="flash-message flash-{{ category }}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="chat-container">
    <a href="{{ url_for('view_connections') }}" class="back-to-connections">‚Üê Back to Connections</a>
    
    <div class="chat-header">
      <div class="chat-user-avatar">
        {% if other_user.customisation and other_user.customisation.profile_picture %}
          <img src="{{ url_for('static', filename='uploads/' + other_user.customisation.profile_picture) }}" alt="{{ other_user.username }}">
        {% else %}
          <div style="font-size: 1.5rem;">üë§</div>
        {% endif %}
      </div>
      <div class="chat-user-info">
        <h2>{{ other_user.username }}</h2>
        {% if other_user.customisation %}
          <p>
            {% if other_user.customisation.faculty %}
              {{ other_user.customisation.faculty }} 
            {% endif %}
            {% if other_user.customisation.course %}
              ‚Ä¢ {{ other_user.customisation.course }}
            {% endif %}
          </p>
        {% endif %}
      </div>
    </div>
    
    <div class="chat-history" id="chat-history">
      {% if messages %}
        {% for message in messages %}
          <div class="message-row {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %}">
            <div class="message {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %}">
              {{ message.content }}
              <div class="message-time">
                {{ (message.created_at.replace(tzinfo=None) + timedelta(hours=8)).strftime('%H:%M | %d %b %Y') }} (GMT+8)
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="no-messages">
          <p>No messages yet. Start the conversation!</p>
        </div>
      {% endif %}
    </div>
    
    <form class="chat-form" action="{{ url_for('send_message', connection_id=connection.id) }}" method="POST">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="text" name="message" class="chat-input" placeholder="Type a message..." autofocus required>
      <button type="submit" class="send-btn">
        <span class="send-icon">‚û§</span>
      </button>
    </form>
  </div>

  <script>
    // Scroll to bottom of chat history on page load
    document.addEventListener('DOMContentLoaded', function() {
      const chatHistory = document.getElementById('chat-history');
      chatHistory.scrollTop = chatHistory.scrollHeight;
    });

  </script>
  
  <script src="{{ url_for('static', filename='js/common.js') }}"></script>
</body>
</html> 